# 投資標的檢查工具 - 完整實作規格文件

## 1. 專案檔案結構

### 1.1 檔案組成

- `index.html` - 主頁面
- `app.js` - 應用程式邏輯
- `styles.css` - 樣式定義

### 1.2 各檔案責任

#### index.html

- 定義頁面基本結構
- 包含一個「更新」按鈕
- 包含卡片容器（用於顯示所有標的資料）
- 包含一個錯誤提示區塊（用於顯示標的清單載入失敗）
- 引入 `styles.css` 和 `app.js`
- 不包含任何內聯樣式或內聯腳本

#### app.js

- 從 Google Apps Script 取得標的清單
- 實作 Yahoo Finance API 呼叫邏輯
- 實作資料處理函式
- 實作技術指標計算函式（MA20、乖離率）
- 實作訊號判斷邏輯
- 實作 UI 更新函式
- 實作錯誤處理
- 綁定「更新」按鈕事件
- 頁面載入時自動執行一次更新

#### styles.css

- 定義卡片樣式
- 定義按鈕樣式
- 定義狀態顏色（綠、黃、紅）
- 定義錯誤訊息樣式
- 保持簡潔、無動畫、無特效

---

## 2. 資料流程

### 2.1 完整流程圖（文字描述）

```
使用者操作
    ↓
[頁面載入] 或 [點擊更新按鈕]
    ↓
對每個標的執行：
    ↓
1. 從 tickers 清單取得 yahooSymbol
    ↓
2. 呼叫 Google Apps Script 取得標的清單（action=tickers）
    ↓
3. 逐檔呼叫 Google Apps Script 轉發 Yahoo Finance Chart API
   請求最近 60 個交易日資料
    ↓
4. API 回傳 JSON 資料
    ↓
5. 解析 JSON，提取：
   - timestamps 陣列（時間戳記）
   - close 陣列（收盤價）
    ↓
6. 驗證資料是否足夠（至少 20 個交易日）
    ↓
   【是】繼續     【否】顯示「資料不足」→ 結束該標的
    ↓
7. 取最近 20 個交易日的收盤價
    ↓
8. 計算 MA20
   = 最近 20 日收盤價的平均值
    ↓
9. 取當日（最新）收盤價
    ↓
10. 計算乖離率
   = (當日收盤價 - MA20) / MA20 × 100
    ↓
11. 判斷 MA20 趨勢方向（比較 MA20_t 與 MA20_t-1）
    ↓
12. 依據「乖離率區間（±2%）」與「MA20 趨勢」判斷狀態（🟢/🟡/🔴）
    ↓
13. 取得最後更新時間（最後一個 timestamp）
    ↓
14. 將結果寫入卡片對應區塊
    ↓
所有標的處理完畢
    ↓
顯示完成
```

### 2.2 並行處理說明

- 所有標的的 API 請求可同時發送（並行）
- 不需等待前一個標的完成
- 每個標的的結果獨立更新到 UI

---

## 3. 資料結構定義

### 3.1 標的清單來源與格式

標的清單改由 Google Apps Script 讀取 Google Sheet 後提供給前端。

Google Sheet 欄位（第 1 列）：
- code | name | yahooSymbol | enabled

說明：
- `code`: 顯示用的標的代碼（原始台股代碼）
- `name`: 中文名稱
- `yahooSymbol`: 實際呼叫 API 使用的格式
- `enabled`: 布林或核取方塊勾選，TRUE 才會納入

前端取得的 tickers 為陣列，每筆格式：
- `{ code, name, yahooSymbol }`

### 3.2 Google Apps Script API 端點

標的清單：
- `?action=tickers`
- 回傳格式：`{ tickers: [...] }`

行情資料：
- `?symbol={yahooSymbol}`

### 3.3 Yahoo Finance API 端點

```
端點格式：
https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?interval=1d&range=3mo

參數說明：
- {symbol}: 替換為 yahooSymbol（如 0050.TW）
- interval=1d: 日線資料
- range=3mo: 取最近 3 個月資料（確保至少有 60 個交易日）
- 若有效交易日不足，顯示資料不足；必要時可改 range=6mo
```

### 3.4 API 回傳資料結構

Yahoo Finance API 回傳 JSON 格式如下：

```
{
  "chart": {
    "result": [
      {
        "meta": { ... },
        "timestamp": [時間戳記陣列],
        "indicators": {
          "quote": [
            {
              "close": [收盤價陣列],
              "open": [開盤價陣列],
              "high": [最高價陣列],
              "low": [最低價陣列],
              "volume": [成交量陣列]
            }
          ]
        }
      }
    ],
    "error": null
  }
}
```

需使用的欄位（由 GAS 轉發後提供）：

- `timestamp` - 時間戳記陣列（Unix timestamp）
- `close` - 收盤價陣列（已過濾 null/undefined/0）

### 3.5 處理後的資料結構（內部使用）

每個標的處理後的資料物件：

```
{
  code: '0050',                    // 標的代碼
  currentPrice: 150.5,             // 當日收盤價
  ma20: 148.2,                     // 20日均線
  deviation: 1.55,                 // 乖離率（%）
  signal: '🟢',                    // 狀態符號
  signalText: '趨勢',              // 狀態文字
  lastUpdate: '2026-01-30',        // 最後更新時間（最後一筆 timestamp）
  error: null                      // 錯誤訊息（若有）
}
```

---

## 4. 指標計算細節

### 4.1 MA20（20日移動平均線）

#### 計算步驟：

1. 確認資料至少有 20 個交易日
2. 取最近 20 個交易日的收盤價
3. 將這 20 個收盤價相加
4. 除以 20
5. 四捨五入至小數點後 2 位

#### 注意事項：

- 必須使用「最近 20 個交易日」，不是日曆日
- 若收盤價陣列中有 null 或 undefined，該筆資料須跳過或標記錯誤
- 確保陣列由舊到新排序（最後一個元素是最新的交易日）

#### 範例：

```
收盤價陣列（最近 20 日）：
[145, 146, 147, 148, 149, 150, 149, 148, 147, 148, 149, 150, 151, 152, 151, 150, 149, 150, 151, 152]

計算：
MA20 = (145 + 146 + ... + 152) / 20 = 149.15
```

### 4.2 乖離率（Deviation %）

#### 計算步驟：

1. 取得當日收盤價（陣列最後一個元素）
2. 取得 MA20 計算結果
3. 計算差值：當日收盤價 - MA20
4. 計算比例：差值 / MA20
5. 乘以 100 轉為百分比
6. 四捨五入至小數點後 2 位

#### 公式：

```
乖離率 = (當日收盤價 - MA20) / MA20 × 100%
```

#### 注意事項：

- 結果可能為正數（價格高於均線）或負數（價格低於均線）
- 保留正負號，顯示時加上 % 符號
- 例：+2.35%、-1.20%

#### 範例：

```
當日收盤價：152
MA20：149.15

計算：
乖離率 = (152 - 149.15) / 149.15 × 100 = 1.91%
```

### 4.3 MA20 趨勢方向判斷

目的：判斷 MA20 是否呈現「走平/上彎」或「下彎」，供 🟢 趨勢判斷使用。

定義
• 計算 今日 MA20（MA20_t）
• 計算 昨日 MA20（MA20_t-1）

規則
• 若 MA20_t ≥ MA20_t-1 → 判定為「走平或上彎」
• 若 MA20_t < MA20_t-1 → 判定為「下彎」

資料需求
• 需至少 21 個有效交易日收盤價 才能同時計算 MA20_t 與 MA20_t-1
（因 MA20_t-1 也需要 20 筆 close）

資料不足處理
• 若有效交易日不足 21：
• MA20 趨勢預設為「走平或上彎」（保守偏多），但仍須符合乖離率規則才會進入 🟢

---

## 5. 訊號判斷流程

### 5.1 判斷邏輯（互斥；優先順序由上而下）

本工具的狀態判斷為互斥（同一日同一標的只會落在其中一種狀態），且**只依據「乖離率門檻」與「MA20 趨勢」**判斷，優先序如下：1. 🟡 接近（觀察）

    •	條件：乖離率 ∈ [-2.00%, +2.00%]（含邊界）
    •	說明：此區間視為「均線糾結區」，不論價格略高或略低皆先歸類為接近。

    2.	🔴 跌破（不進）

    •	條件：乖離率 < -2.00%
    •	說明：跌破區為趨勢轉弱或偏空，避免進場。

    3.	🟢 趨勢（可進）

    •	條件：乖離率 > +2.00% 且 MA20 趨勢為「走平或上彎」
    •	說明：必須脫離糾結區並確認均線不下彎，才視為趨勢成立。

註：此設計目的在於「避免在均線附近頻繁翻多翻空」，並降低追高與假突破噪音。

### 5.2 判斷流程圖（文字描述）

```
開始
  ↓
計算 deviationPercent（乖離率%）與 ma20Trend（走平/上彎 或 下彎）
  ↓
若 deviationPercent 在 [-2%, +2%]（含） → 🟡 接近
否則若 deviationPercent < -2% → 🔴 跌破
否則（deviationPercent > +2%）：
    若 ma20Trend 為 走平/上彎 → 🟢 趨勢
    否則（下彎） → 🔴 跌破
  ↓
結束

```

### 5.3 邊界條件說明

    •	乖離率 = +2.00% 或 -2.00%：判定為 🟡 接近
    •	若乖離率 > +2.00% 但 MA20 為下彎：判定為 🔴 跌破（保守原則）

### 5.4 函式契約（禁止額外條件）

    •	determineSignal(deviationPercent, ma20Trend) 必須只依據「乖離率門檻」與「MA20 趨勢」回傳狀態，不得再額外加入其他條件。

## • ma20Trend 的允許值只接受兩種："UP_OR_FLAT" / "DOWN"（或中文「走平/上彎」「下彎」），避免 Codex 自創第三種狀態。

## 6. 錯誤處理與邊界情況

### 6.1 API 請求失敗

#### 情境：

- 網路連線失敗
- Google Apps Script 標的清單 API 回傳錯誤
- Yahoo Finance API 回傳 HTTP 錯誤（4xx, 5xx）
- API 回傳格式不符預期

#### 處理方式：

- 標的清單失敗時顯示「無法取得標的清單」錯誤區塊，且不進行後續抓價
- 單一標的失敗時顯示錯誤訊息：「API 錯誤」或「無法取得資料」
- 其他欄位留空或顯示 "-"
- 不影響其他標的的顯示
- 在瀏覽器 console 記錄詳細錯誤訊息（供開發除錯用）

### 6.2 資料不足

#### 情境 1：交易日少於 20 天

- 回傳資料的 timestamp 陣列長度 < 20

處理方式：

- 該標的卡片顯示「資料不足」
- 其他欄位留空或顯示 "-"

#### 情境 2：交易日介於 20-23 天

- 可計算 MA20 和乖離率
- 無法計算 MA20 趨勢方向

處理方式：

- 顯示當日收盤價、MA20、乖離率
- 訊號判斷時，將 MA20 視為「走平」

### 6.3 非交易日

#### 情境：

- 週末、假日執行更新
- API 回傳的最後一筆資料不是當天

#### 處理方式：

- 使用 API 回傳的最後一筆交易日資料
- 最後更新時間顯示該交易日的日期
- 不顯示任何警告或錯誤（正常行為）

### 6.4 收盤價為 null 或異常值

#### 情境：

- API 回傳的 close 陣列中有 null、undefined 或 0
- close 過濾時需同步移除對應 timestamp，確保索引一致。

#### 處理方式：

- 在計算 MA20 前先過濾掉 null/undefined/0 的值
- 若過濾後資料少於 20 筆，顯示「資料不足」
- 若僅當日收盤價為 null，顯示「資料異常」

### 6.5 標的代碼錯誤

#### 情境：

- 標的清單中的代碼在 Yahoo Finance 不存在

#### 處理方式：

- 視同 API 錯誤處理
- 顯示「無法取得資料」

### 6.6 CORS 與部署策略（定案）

由於 Yahoo Finance chart API 可能在 GitHub Pages（純靜態站）環境出現 CORS 限制，本專案需採用以下策略確保「線上可用」。

採用方案：Google Apps Script 轉發（推薦且可控）
• 前端不直接呼叫 Yahoo Finance
• 前端改呼叫自建的 Google Apps Script Web App endpoint
• GAS 負責：
• 讀取 Google Sheet 取得標的清單（action=tickers）
• 代為向 Yahoo Finance 取得資料
• 回傳必要欄位（timestamp、close）給前端
• 僅允許查詢清單內存在的 yahooSymbol（白名單）
• 快取標的清單與行情資料（60 秒）
• 優點：
• GitHub Pages 可正常運作
• 不依賴第三方 proxy
• 可集中管理標的清單

退而求其次（僅限本機開發）
• 若未部署 GAS，允許在本機透過 VSCode Live Server 測試
• 但不保證 GitHub Pages 可用

備註：第一版（MVP）以「線上可用」為目標，優先完成 GAS 轉發通路，再進行 UI/功能擴充。

---

## 7. UI 欄位與更新邏輯

### 7.1 頁面標題

```
顯示文字：「投資標的每日檢查」
HTML 結構：<h1> 標籤
位置：頁面最上方
```

### 7.2 更新按鈕

```
顯示文字：「更新」
HTML 結構：<button> 標籤
位置：標題下方
行為：
  - 點擊時觸發所有標的資料更新
  - 更新期間按鈕顯示「更新中...」並禁用
  - 更新完成後恢復「更新」文字並啟用
```

### 7.2.1 錯誤提示區塊

- 若標的清單取得失敗，顯示醒目的錯誤提示區塊
- 錯誤訊息為「無法取得標的清單」

### 7.3 卡片結構

#### 卡片欄位（由上而下）：

- 標的代碼 + 中文名稱
- 狀態（燈號 + 文字）
- 當日收盤（大字）
- 次要資訊：MA20、乖離率、更新日期

#### HTML 結構：

```
<div id="cards" class="cards-grid">
  <!-- 每個標的一張卡片 -->
</div>
```

### 7.4 卡片產生邏輯

#### 正常情況：

- 每個標的產生一張卡片
- 狀態依照 signal 類型套用不同 CSS class：
  - 🟢 趨勢：class="signal-green"
  - 🟡 接近：class="signal-yellow"
  - 🔴 跌破：class="signal-red"

#### 錯誤情況：

- 若發生錯誤，該卡片顯示：
  - 標的代碼與名稱：正常顯示
  - 其他欄位：顯示 "-"
  - 狀態：顯示錯誤訊息（如「API 錯誤」、「資料不足」）
  - 套用 class="error"

### 7.5 更新流程

#### 初次載入：

1. 頁面 DOM 載入完成後（DOMContentLoaded）
2. 自動執行一次更新
3. 顯示「載入中...」訊息或骨架屏（可選）

#### 手動更新：

1. 使用者點擊「更新」按鈕
2. 按鈕文字改為「更新中...」並禁用
3. 清空卡片內容
4. 先取得標的清單（action=tickers），失敗則顯示錯誤訊息並停止後續抓價
5. 對所有標的並行發送 API 請求
6. 每個標的完成後，立即插入該卡片
7. 所有標的完成後：
   - 按鈕恢復「更新」文字
   - 啟用按鈕

### 7.6 時間格式轉換

#### 輸入：Unix timestamp（秒）

來源：API 回傳的 timestamp 陣列

#### 輸出：YYYY-MM-DD

範例：2026-01-30

#### 轉換步驟：

1. 將 Unix timestamp 乘以 1000（轉為毫秒）
2. 建立 Date 物件
3. 提取年、月、日
4. 格式化為 YYYY-MM-DD
   - 月、日若為單位數，前面補 0

#### 注意事項：

- 時區使用使用者本地時區
- Yahoo Finance 回傳的時間已是對應市場的收盤時間

### 7.7 數值格式化

#### 價格（當日收盤、MA20）：

- 四捨五入至小數點後 2 位
- 範例：150.50（不是 150.5）

#### 乖離率：

- 四捨五入至小數點後 2 位
- 保留正負號
- 加上 % 符號
- 範例：+2.35%、-1.20%、+0.00%

### 7.8 使用說明補充

- 在使用說明區塊下方顯示一行紅色提醒文字，內容為「本工具使用每日收盤價計算，建議於收盤後查看，一天看一次即可，用來觀察趨勢狀態，不適合盤中即時交易。」

---

## 8. 樣式規範（CSS）

### 8.1 整體樣式

- 字體：系統預設字體（sans-serif）
- 背景：白色或淺灰色
- 寬度：固定或自適應（不超過 1200px）
- 置中顯示

### 8.2 卡片樣式

- 版面使用 CSS Grid
- 卡片具圓角與輕微陰影
- 標的代碼較醒目，名稱次要
- 狀態區塊清楚顯示燈號與文字
- 次要資訊以小字排列（MA20、乖離率、更新日期）

### 8.3 狀態顏色

- 🟢 趨勢（signal-green）：
  - 背景色：淺綠色（#d4edda）
  - 文字色：深綠色（#155724）
- 🟡 接近（signal-yellow）：
  - 背景色：淺黃色（#fff3cd）
  - 文字色：深黃色（#856404）
- 🔴 跌破（signal-red）：
  - 背景色：淺紅色（#f8d7da）
  - 文字色：深紅色（#721c24）

### 8.4 錯誤樣式（error）

- 背景色：淺灰色或灰色區塊
- 文字色：深灰色（#666）
- 卡片邊框顏色偏灰

### 8.5 按鈕樣式

- 預設狀態：
  - 背景：藍色或深灰色
  - 文字：白色
  - 圓角：4px
  - padding：10px 20px
  - cursor：pointer
- hover 狀態：
  - 背景：稍微深一點的顏色
- 禁用狀態（更新中）：
  - 背景：淺灰色
  - cursor：not-allowed
  - 不可點擊

### 8.6 響應式設計（可選，但建議）

- 在小螢幕（<768px）時：
  - 字體稍微縮小
  - 卡片改為單欄排列
  - 按鈕寬度 100%
- 在中型螢幕（768px–1023px）時：
  - 卡片為兩欄排列
- 在大螢幕（>=1024px）時：
  - 卡片為三欄排列

---

## 9. 技術實作要點

### 9.1 JavaScript 模組化建議

雖然不使用框架，但建議將程式碼分成以下函式：

- `init()` - 初始化，綁定事件
- `updateAll()` - 更新所有標的
- `fetchTickersList()` - 取得標的清單（action=tickers）
- `fetchTickerData(yahooSymbol)` - 呼叫 API
- `parseAPIResponse(response)` - 解析 API 回傳
- `calculateMA20(closePrices)` - 計算 MA20
- `calculateDeviation(currentPrice, ma20)` - 計算乖離率
- `determineTrend(ma20Array)` - 判斷 MA20 趨勢
- `determineSignal(currentPrice, ma20, trend)` - 判斷訊號
- `renderCard(tickerData)` - 渲染卡片
- `formatDate(timestamp)` - 格式化時間
- `handleError(ticker, error)` - 處理錯誤
- `showError(message)` / `clearError()` - 顯示或清除標的清單錯誤提示

### 9.2 API 呼叫注意事項

- 使用 `fetch()` API
- 設定 timeout（建議 10 秒）
- 使用 try-catch 捕捉錯誤
- 並行請求使用 `Promise.all()`

### 9.3 效能考量

- 避免不必要的 DOM 操作
- 使用 DocumentFragment 批次插入列（可選）
- 不需要做防抖或節流（使用者手動更新頻率不高）

### 9.4 瀏覽器相容性

- 使用現代瀏覽器支援的 ES6+ 語法
- 不需支援 IE
- 目標瀏覽器：Chrome, Firefox, Safari, Edge（最新版）

---

## 10. 測試檢查點（實作完成後驗證）

### 10.1 功能測試

- [ ] 頁面載入後自動更新一次
- [ ] 點擊「更新」按鈕可手動更新
- [ ] 成功取得 tickers 清單並顯示所有卡片
- [ ] MA20 計算正確（可用 Excel 驗證）
- [ ] 乖離率計算正確
- [ ] 訊號判斷符合規則

### 10.2 錯誤處理測試

- [ ] 斷網情況下顯示錯誤訊息
- [ ] 錯誤不影響其他標的顯示
- [ ] 資料不足時顯示「資料不足」
- [ ] tickers 清單失敗時顯示「無法取得標的清單」

### 10.3 UI 測試

- [ ] 狀態顏色正確（綠、黃、紅）
- [ ] 時間格式正確
- [ ] 數值格式正確（小數點 2 位）
- [ ] 卡片可讀性良好

### 10.4 邊界測試

- [ ] 週末執行顯示最後交易日資料
- [ ] 價格等於 MA20 時判斷為「接近」
- [ ] 價格在 MA20 ±2% 邊界時判斷正確

---

## 11. 部署至 GitHub Pages

### 11.1 檔案準備

- 確認三個檔案都在專案根目錄：
  - index.html
  - app.js
  - styles.css

### 11.2 部署步驟

1. 將專案推送到 GitHub repository
2. 進入 repository 的 Settings
3. 找到 Pages 設定
4. Source 選擇 main branch
5. 儲存後等待部署完成
6. 訪問提供的 GitHub Pages URL

### 11.3 注意事項

- 確認所有檔案路徑為相對路徑
- 測試線上版本是否有 CORS 問題
- 若有 CORS 問題，在文件中說明解決方案

---

## 12. 未來擴充預留

雖然現在不做，但程式碼結構應該便於未來擴充：

### 12.1 標的清單改由外部來源

- 標的清單已由 Google Sheet 管理
- 未來可擴充欄位或加上分群管理

### 12.2 自訂參數

- MA 天數（現在固定 20）可改為變數
- 接近範圍（現在固定 ±2%）可改為變數

### 12.3 儲存歷史紀錄

- 每次更新的結果可選擇性存入 localStorage
- 未來可做歷史趨勢圖

### 12.4 通知功能

- 預留「訂閱通知」按鈕位置
- 未來可串接 Telegram Bot 或 Email

---

## 13. 開發順序建議

### 階段 1：基礎架構

1. 建立 index.html 基本結構
2. 建立 styles.css 基本樣式
3. 建立 app.js 框架（函式定義）

### 階段 2：資料取得

4. 實作 API 呼叫
5. 實作資料解析
6. 測試能否正確取得資料

### 階段 3：計算邏輯

7. 實作 MA20 計算
8. 實作乖離率計算
9. 實作訊號判斷
10. 測試計算正確性

### 階段 4：UI 顯示

11. 實作卡片渲染
12. 實作時間格式化
13. 實作狀態顏色
14. 測試顯示效果

### 階段 5：互動與錯誤處理

15. 綁定更新按鈕
16. 實作錯誤處理
17. 實作載入狀態
18. 完整測試

### 階段 6：優化與部署

19. 樣式調整
20. 效能優化（如有需要）
21. 部署到 GitHub Pages
22. 線上測試

---

## 14. 附錄：規則判斷範例

### 範例 1：🟢 趨勢（可進）

```
標的：0050
當日收盤：152.00
MA20：148.50
乖離率：(152 - 148.5) / 148.5 × 100 = 2.36%
MA20 趨勢：上彎
判斷：乖離率 2.36%（> +2%）且 MA20 走平/上彎 → 🟢 趨勢
```

### 範例 2：🟡 接近（觀察）

```
標的：00955
當日收盤：50.20
MA20：50.00
乖離率：(50.2 - 50) / 50 × 100 = 0.40%
判斷：差異在 ±2% 內 → 🟡 接近
```

### 範例 3：🔴 跌破（不進）

```
標的：00910
當日收盤：45.50
MA20：47.00
乖離率：(45.5 - 47) / 47 × 100 = -3.19%
判斷：乖離率 -3.19%（< -2%）→ 🔴 跌破
```

### 範例 4：邊界情況 - 剛好 +2%

```
標的：00631L
當日收盤：51.00
MA20：50.00
乖離率：(51 - 50) / 50 × 100 = 2.00%
判斷：差異 = 2%，在 ±2% 內 → 🟡 接近
```

---

## 結束

此規格文件涵蓋所有實作細節，任何開發者或 AI 助手應能依此文件完整實作出符合需求的工具。

若實作過程中發現規格不清楚或有矛盾之處，應回頭檢查 SPEC.md 並以其為準。
